<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Formation Matcher – Lost Souls</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase SDKs (COMPAT) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0;
      padding: 1.5rem;
      background: #050816;
      color: #f9fafb;
    }
    .app {
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .subtitle {
      color: #9ca3af;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    /* --- Lost Souls Emblem --- */
    .lost-souls-emblem {
      margin: 1rem 0 1.8rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      text-shadow:
        0 0 8px rgba(255, 0, 122, 0.6),
        0 0 14px rgba(255, 0, 122, 0.4);
      animation: ls-pulse 2.8s infinite ease-in-out;
    }

    .ls-skull {
      font-size: 3.2rem;
      color: #ff007a;
    }

    .ls-text {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: linear-gradient(to right, #ff4fa7, #ff1b70);
      -webkit-background-clip: text;
      color: transparent;
    }

    @keyframes ls-pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.06); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Cards */
    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 18px 40px rgba(15,23,42,0.65);
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
      flex-wrap: wrap;
    }

    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.25rem;
    }

    input {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
    }

    .grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 700px) {
      .grid-3 {
        grid-template-columns: 1.2fr 1.2fr 0.6fr;
      }
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1.1rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: white;
    }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-danger {
      background: #7f1d1d;
      color: #fee2e2;
    }

    .muted {
      color: #6b7280;
      font-size: 0.8rem;
    }

    /* Table */
    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 0.75rem;
      border: 1px solid rgba(31,41,55,0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
    }

    th, td {
      padding: 0.45rem 0.55rem;
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.7);
    }

    /* Pairing */
    .pairs {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 700px) {
      .pairs {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .pair-card {
      border-radius: 0.9rem;
      padding: 0.8rem;
      border: 1px solid rgba(34,197,94,0.35);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.18), rgba(15,23,42,0.95));
    }

    .chip {
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 0.7rem;
    }

    .status-bar {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 0.5rem;
    }
  </style>
</head>

<body>
  <div class="app">

    <h1>Formation Matcher</h1>

    <!-- Lost Souls Emblem -->
    <div class="lost-souls-emblem">
      <div class="ls-skull">☠</div>
      <div class="ls-text">Lost Souls</div>
    </div>

    <p class="subtitle">Submit formations and generate optimal reinforcement pairs.</p>
    <div id="status" class="status-bar">Connecting to database…</div>

    <!-- Input -->
    <div class="card">
      <div class="card-header"><strong>Add Formation</strong></div>

      <div class="grid grid-3">
        <div>
          <label>Player Name</label>
          <input id="playerName" placeholder="E.g Noname" />
        </div>
        <div>
          <label>Formation</label>
          <input id="formationName" placeholder="Formation 1/2/3" />
        </div>
        <div>
          <label>Power</label>
          <input id="power" type="number" placeholder="e.g. 15432" />
        </div>
      </div>

      <div style="display:flex; gap:0.5rem; margin-top:1rem;">
        <button class="btn-primary" id="addFormationBtn">+ Add</button>
        <button class="btn-secondary" id="clearAllBtn">Clear All</button>
      </div>
    </div>

    <!-- Registered formations -->
    <div class="card">
      <div class="card-header">
        <strong>Registered Formations</strong>
        <span class="muted" id="countInfo">(0)</span>
        <button class="btn-primary" id="makePairsBtn">⚔ Generate Pairs</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>Formation</th>
              <th>Power</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="formationsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Pair results -->
    <div class="card">
      <div class="card-header"><strong>Pairing Results</strong></div>
      <div id="pairsContainer" class="muted">No pairs yet.</div>
    </div>

  </div>

<script>
  const statusEl = document.getElementById("status");

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDjK7eKaCvB0Yz3ITqvfhxS7EeCdR0_Ejk",
    authDomain: "tides-matcher.firebaseapp.com",
    projectId: "tides-matcher",
    storageBucket: "tides-matcher.firebasestorage.app",
    messagingSenderId: "783442473196",
    appId: "1:783442473196:web:715f21a86293d9bc7e35c9",
    measurementId: "G-MBN8G0FSFJ"
  };

  let db, formationsRef, pairsRef;
  const formations = [];
  const ADMIN_CODE = "ZOMBIE-ADMIN-2025";

  const playerInput = document.getElementById("playerName");
  const formationInput = document.getElementById("formationName");
  const powerInput = document.getElementById("power");
  const formationsBody = document.getElementById("formationsBody");
  const pairsContainer = document.getElementById("pairsContainer");
  const countInfo = document.getElementById("countInfo");

  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    formationsRef = db.collection("formations");
    pairsRef = db.collection("pairs");
    statusEl.textContent = "Connected to database.";
  } catch (e) {
    console.error("Firebase init error:", e);
    statusEl.textContent = "Error: could not connect to database.";
  }

  // ---------- Live formations fra Firestore ----------
  if (formationsRef) {
    formationsRef.orderBy("power").onSnapshot(
      snapshot => {
        formations.length = 0;
        snapshot.forEach(doc => {
          formations.push({ id: doc.id, ...doc.data() });
        });
        renderList();
      },
      err => {
        console.error("onSnapshot error:", err);
        statusEl.textContent = "Database error: " + err.message;
      }
    );
  }

  // ---------- Add formation ----------
  document.getElementById("addFormationBtn").onclick = async () => {
    if (!formationsRef) {
      alert("Database not connected.");
      return;
    }
    const player = playerInput.value.trim();
    const form = formationInput.value.trim();
    const powerVal = powerInput.value.trim();

    if (!player || !form || !powerVal) return alert("Fill all fields correctly.");

    const power = Number(powerVal);
    if (isNaN(power)) return alert("Power must be a number.");

    try {
      await formationsRef.add({ player, formation: form, power });
      playerInput.value = "";
      formationInput.value = "";
      powerInput.value = "";
    } catch (e) {
      console.error("Add error:", e);
      alert("Failed to add formation: " + e.message);
    }
  };

  // ---------- Clear all ----------
  document.getElementById("clearAllBtn").onclick = async () => {
    if (!formationsRef || !pairsRef) {
      alert("Database not connected.");
      return;
    }
    const given = prompt("Admin code:");
    if (given !== ADMIN_CODE) return alert("Incorrect code.");
    if (!confirm("Delete EVERYTHING from formations AND pairs?")) return;

    try {
      // Slett formations
      const snapF = await formationsRef.get();
      const batch = db.batch();
      snapF.forEach(doc => batch.delete(doc.ref));

      // Slett pairs
      const snapP = await pairsRef.get();
      snapP.forEach(doc => batch.delete(doc.ref));

      await batch.commit();
    } catch (e) {
      console.error("Clear all error:", e);
      alert("Failed to clear list: " + e.message);
    }
  };

  // ---------- Generate & save pairs ----------
  document.getElementById("makePairsBtn").onclick = async () => {
    if (formations.length < 2) {
      alert("Need at least 2 formations.");
      return;
    }
    const result = generatePairs();
    renderPairs(result);
    await savePairsToDb(result);
  };

  // ---------- Render formations-liste ----------
  function renderList() {
    formationsBody.innerHTML = "";
    formations.forEach((f, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${escapeHtml(f.player)}</td>
        <td>${escapeHtml(f.formation)}</td>
        <td>${f.power}</td>
        <td><button class="btn-danger" data-id="${f.id}">✕</button></td>`;
      formationsBody.appendChild(tr);
    });

    document.querySelectorAll("[data-id]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-id");
        try {
          await formationsRef.doc(id).delete();
        } catch (e) {
          console.error("Delete error:", e);
          alert("Failed to delete: " + e.message);
        }
      };
    });

    countInfo.textContent = `(${formations.length})`;
    if (!formations.length) {
      pairsContainer.innerHTML = "<span class='muted'>No pairs yet.</span>";
    }
  }

  // ---------- Pairing-logikk ----------
  function generatePairs() {
    const list = [...formations].sort((a, b) => a.power - b.power);
    const used = new Set();
    const pairs = [];
    const leftover = [];

    for (let i = 0; i < list.length; i++) {
      const A = list[i];
      if (used.has(A.id)) continue;

      let best = null;
      let diff = Infinity;

      for (let j = i + 1; j < list.length; j++) {
        const B = list[j];
        if (used.has(B.id)) continue;
        if (A.player === B.player) continue;

        const d = Math.abs(A.power - B.power);
        if (d < diff) {
          diff = d;
          best = B;
        }
      }

      if (best) {
        used.add(A.id);
        used.add(best.id);
        pairs.push({ a: A, b: best, diff });
      } else {
        leftover.push(A);
      }
    }

    return { pairs, leftover };
  }

  // ---------- Lagre genererte par i Firestore ----------
  async function savePairsToDb({ pairs }) {
    if (!pairsRef) return;
    try {
      // Slett tidligere par
      const snap = await pairsRef.get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));

      // Legg til nye par
      pairs.forEach((p, index) => {
        const ref = pairsRef.doc();
        batch.set(ref, {
          index,
          aId: p.a.id,
          aPlayer: p.a.player,
          aFormation: p.a.formation,
          aPower: p.a.power,
          bId: p.b.id,
          bPlayer: p.b.player,
          bFormation: p.b.formation,
          bPower: p.b.power,
          diff: p.diff,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      await batch.commit();
      statusEl.textContent = "Pairs saved to database.";
      setTimeout(() => {
        statusEl.textContent = "Connected to database.";
      }, 3000);
    } catch (e) {
      console.error("Save pairs error:", e);
      alert("Failed to save pairs: " + e.message);
    }
  }

  // ---------- Render pairs ----------
  function renderPairs({ pairs, leftover }) {
    if (pairs.length === 0) {
      pairsContainer.innerHTML = "<span class='muted'>No valid pairs.</span>";
      return;
    }

    const wrap = document.createElement("div");
    wrap.className = "pairs";

    pairs.forEach((p, i) => {
      const card = document.createElement("div");
      card.className = "pair-card";
      card.innerHTML = `
        <strong>Pair ${i + 1}</strong> — Diff: ${p.diff}<br><br>
        <span class="chip">${escapeHtml(p.a.player)}</span> — ${escapeHtml(p.a.formation)} (${p.a.power})<br>
        <span class="chip">${escapeHtml(p.b.player)}</span> — ${escapeHtml(p.b.formation)} (${p.b.power})
      `;
      wrap.appendChild(card);
    });

    if (leftover.length > 0) {
      const miss = document.createElement("div");
      miss.style.marginTop = "1rem";
      miss.innerHTML = "<strong>Unpaired:</strong><br>" +
        leftover.map(f => `${escapeHtml(f.player)} — ${escapeHtml(f.formation)} (${f.power})`).join("<br>");
      wrap.appendChild(miss);
    }

    pairsContainer.innerHTML = "";
    pairsContainer.appendChild(wrap);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }
</script>

</body>
</html>


