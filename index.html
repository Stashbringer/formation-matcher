<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Formation Matcher – Lost Souls</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase SDKs (COMPAT) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0;
      padding: 1.5rem;
      background: #050816;
      color: #f9fafb;
    }
    .app {
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .subtitle {
      color: #9ca3af;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    /* --- Lost Souls Emblem --- */
    .lost-souls-emblem {
      margin: 1rem 0 0.8rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      text-shadow:
        0 0 8px rgba(255, 0, 122, 0.6),
        0 0 14px rgba(255, 0, 122, 0.4);
      animation: ls-pulse 2.8s infinite ease-in-out;
    }

    .ls-skull {
      font-size: 3.2rem;
      color: #ff007a;
    }

    .ls-text {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: linear-gradient(to right, #ff4fa7, #ff1b70);
      -webkit-background-clip: text;
      color: transparent;
    }

    @keyframes ls-pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.06); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Cards */
    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow: 0 18px 40px rgba(15,23,42,0.65);
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.25rem;
    }

    input {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
    }

    .grid {
      display: grid;
      gap: 0.75rem;
    }

    @media (min-width: 700px) {
      .grid-3 {
        grid-template-columns: 1.2fr 1.2fr 0.6fr;
      }
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.5rem 1.1rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary {
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: white;
    }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-danger {
      background: #7f1d1d;
      color: #fee2e2;
    }

    .muted {
      color: #6b7280;
      font-size: 0.8rem;
    }

    /* Table */
    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 0.75rem;
      border: 1px solid rgba(31,41,55,0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #020617;
    }

    th, td {
      padding: 0.45rem 0.55rem;
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.7);
    }

    /* Pairing – kompakte grønne bokser */
    .pairs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .pair-card {
      display: inline-flex;
      flex-direction: column;
      padding: 0.45rem 0.65rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(34,197,94,0.7);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.16), rgba(15,23,42,0.98));
      font-size: 0.78rem;
      max-width: 360px;
    }

    .pair-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.25rem;
    }

    .pair-title {
      font-weight: 600;
      color: #e5e7eb;
      white-space: nowrap;
    }

    .pair-meta {
      font-size: 0.7rem;
      color: #9ca3af;
      white-space: nowrap;
    }

    .pair-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      align-items: baseline;
      line-height: 1.3;
    }

    .pair-name {
      font-weight: 600;
      color: #f9fafb;
    }

    .pair-sep {
      color: #9ca3af;
    }

    .pair-form {
      color: #a5b4fc;
    }

    .pair-power {
      color: #facc15;
    }

    /* Top 3 highlight */
    .gold-glow {
      color: #facc15 !important;
      text-shadow:
        0 0 6px rgba(250, 204, 21, 0.7),
        0 0 14px rgba(250, 204, 21, 0.5),
        0 0 22px rgba(250, 204, 21, 0.3);
      animation: goldPulse 2.4s infinite ease-in-out;
    }

    @keyframes goldPulse {
      0% { opacity: 1; text-shadow: 0 0 6px rgba(250, 204, 21, 0.7); }
      50% { opacity: 0.75; text-shadow: 0 0 14px rgba(250, 204, 21, 1); }
      100% { opacity: 1; text-shadow: 0 0 6px rgba(250, 204, 21, 0.7); }
    }

    .status-bar {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 0.5rem;
      cursor: default;
    }

    .admin-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .admin-pill {
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
    }
    .btn-xs {
      padding: 0.25rem 0.7rem;
      font-size: 0.75rem;
    }

    .pair-search {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .pair-search input {
      width: 180px;
      font-size: 0.78rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
    }
  </style>
</head>

<body>
  <div class="app">

    <h1>Formation Matcher</h1>

    <!-- Lost Souls Emblem -->
    <div class="lost-souls-emblem">
      <div class="ls-skull">☠</div>
      <div class="ls-text">Lost Souls</div>
    </div>

    <p class="subtitle">Submit formations and generate optimal reinforcement pairs.</p>
    <div id="status" class="status-bar" title="(hint: double-click for admin unlock)">Connected to database…</div>

    <!-- Admin bar -->
    <div class="admin-bar">
      <span class="admin-pill">
        Admin status:
        <span id="adminStatusText">Not logged in</span>
      </span>
      <button class="btn-secondary btn-xs" id="adminLoginBtn" style="display:none;">Admin login (Google)</button>
      <button class="btn-secondary btn-xs" id="adminLogoutBtn" style="display:none;">Logout</button>
    </div>

    <!-- Input -->
    <div class="card">
      <div class="card-header"><strong>Add Formation</strong></div>

      <div class="grid grid-3">
        <div>
          <label>Player Name</label>
          <input id="playerName" placeholder="E.g Noname" />
        </div>
        <div>
          <label>Formation (1–4)</label>
          <input
            id="formationName"
            type="number"
            min="1"
            max="4"
            step="1"
            inputmode="numeric"
            placeholder="Formation 1/2/3"
          />
        </div>
        <div>
          <label>Power</label>
          <input id="power" type="number" placeholder="e.g. 15432" />
        </div>
      </div>

      <div style="display:flex; gap:0.5rem; margin-top:1rem;">
        <button class="btn-primary" id="addFormationBtn">+ Add</button>
        <button class="btn-secondary" id="clearAllBtn">Clear All</button>
      </div>
    </div>

    <!-- Registered formations -->
    <div class="card">
      <div class="card-header">
        <strong>Registered Formations</strong>
        <span class="muted" id="countInfo">(0)</span>
        <button class="btn-primary" id="makePairsBtn">⚔ Generate Pairs</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>Formation</th>
              <th>Power</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="formationsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Pair results -->
    <div class="card">
      <div class="card-header">
        <strong>Pairing Results</strong>
        <div class="pair-search">
          <input id="pairSearch" placeholder="Search player in pairs..." />
        </div>
      </div>
      <div id="pairsContainer" class="muted">No pairs yet.</div>
    </div>

  </div>

<script>
  const statusEl = document.getElementById("status");
  const adminStatusText = document.getElementById("adminStatusText");
  const adminLoginBtn = document.getElementById("adminLoginBtn");
  const adminLogoutBtn = document.getElementById("adminLogoutBtn");
  const pairSearchInput = document.getElementById("pairSearch");

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDjK7eKaCvB0Yz3ITqvfhxS7EeCdR0_Ejk",
    authDomain: "tides-matcher.firebaseapp.com",
    projectId: "tides-matcher",
    storageBucket: "tides-matcher.firebasestorage.app",
    messagingSenderId: "783442473196",
    appId: "1:783442473196:web:715f21a86293d9bc7e35c9",
    measurementId: "G-MBN8G0FSFJ"
  };

  let db, formationsRef, pairsRef, auth;
  const formations = [];
  let pairsFromDb = [];
  let isAdmin = false;
  let currentPairsResult = null; // full set of pairs + leftover

  const ADMIN_UID = "I51aLQJZMjO960ykC2AUlNOVbIE3";
  const ADMIN_CODE = "ZOMBIE-ADMIN-2025";

  const playerInput = document.getElementById("playerName");
  const formationInput = document.getElementById("formationName");
  const powerInput = document.getElementById("power");
  const formationsBody = document.getElementById("formationsBody");
  const pairsContainer = document.getElementById("pairsContainer");
  const countInfo = document.getElementById("countInfo");

  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    formationsRef = db.collection("formations");
    pairsRef = db.collection("pairs");
    statusEl.textContent = "Connected to database.";
  } catch (e) {
    console.error("Firebase init error:", e);
    statusEl.textContent = "Error: could not connect to database.";
  }

  // ---------- Skjult admin-unlock: dobbeltklikk på status-linje ----------
  statusEl.addEventListener("dblclick", () => {
    const code = prompt("Admin code:");
    if (code === ADMIN_CODE) {
      adminLoginBtn.style.display = "inline-block";
      alert("Admin login unlocked. Use Google to sign in.");
    } else if (code !== null) {
      alert("Wrong admin code.");
    }
  });

  // ---------- Admin login / logout ----------
  if (auth) {
    auth.onAuthStateChanged(user => {
      if (user && user.uid === ADMIN_UID) {
        isAdmin = true;
        adminStatusText.textContent = "Logged in as admin (" + (user.email || "unknown") + ")";
        adminLoginBtn.style.display = "none";
        adminLogoutBtn.style.display = "inline-block";
      } else if (user) {
        isAdmin = false;
        adminStatusText.textContent = "Logged in (not admin): " + (user.email || "unknown") + "";
        adminLoginBtn.style.display = "none";
        adminLogoutBtn.style.display = "inline-block";
      } else {
        isAdmin = false;
        adminStatusText.textContent = "Not logged in";
        adminLogoutBtn.style.display = "none";
      }
      renderList();
      if (currentPairsResult) {
        renderPairsFiltered();
      }
    });

    adminLoginBtn.onclick = async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
      } catch (e) {
        console.error("Login error:", e);
        alert("Login failed: " + e.message);
      }
    };

    adminLogoutBtn.onclick = async () => {
      try {
        await auth.signOut();
      } catch (e) {
        console.error("Logout error:", e);
        alert("Logout failed: " + e.message);
      }
    };
  }

  // ---------- Live formations ----------
  if (formationsRef) {
    formationsRef.orderBy("power").onSnapshot(
      snapshot => {
        formations.length = 0;
        snapshot.forEach(doc => {
          formations.push({ id: doc.id, ...doc.data() });
        });
        renderList();
        if (pairsFromDb.length > 0) {
          setPairsResult(buildPairsResultFromDb());
        }
      },
      err => {
        console.error("onSnapshot formations error:", err);
        statusEl.textContent = "Database error (formations): " + err.message;
      }
    );
  }

  // ---------- Live pairs ----------
  if (pairsRef) {
    pairsRef.orderBy("index").onSnapshot(
      snapshot => {
        pairsFromDb.length = 0;
        snapshot.forEach(doc => {
          const d = doc.data();
          pairsFromDb.push({
            a: {
              id: d.aId,
              player: d.aPlayer,
              formation: d.aFormation,
              power: d.aPower
            },
            b: {
              id: d.bId,
              player: d.bPlayer,
              formation: d.bFormation,
              power: d.bPower
            },
            diff: d.diff,
            total: d.total ?? (d.aPower + d.bPower)
          });
        });

        if (pairsFromDb.length === 0) {
          currentPairsResult = null;
          pairsContainer.innerHTML = "<span class='muted'>No pairs yet.</span>";
          return;
        }

        const result = buildPairsResultFromDb();
        setPairsResult(result);
        statusEl.textContent = "Pairs loaded from database.";
        setTimeout(() => {
          statusEl.textContent = "Connected to database.";
        }, 3000);
      },
      err => {
        console.error("onSnapshot pairs error:", err);
        statusEl.textContent = "Database error (pairs): " + err.message;
      }
    );
  }

  function buildPairsResultFromDb() {
    const usedIds = new Set();
    pairsFromDb.forEach(p => {
      if (p.a && p.a.id) usedIds.add(p.a.id);
      if (p.b && p.b.id) usedIds.add(p.b.id);
    });

    const leftover = formations.filter(f => !usedIds.has(f.id));
    return { pairs: pairsFromDb, leftover };
  }

  // ---------- Manage current pairs result + filtering ----------
  function setPairsResult(result) {
    currentPairsResult = result;
    renderPairsFiltered();
  }

  function renderPairsFiltered() {
    if (!currentPairsResult) {
      pairsContainer.innerHTML = "<span class='muted'>No pairs yet.</span>";
      return;
    }
    const term = pairSearchInput ? pairSearchInput.value.trim().toLowerCase() : "";
    if (!term) {
      renderPairs(currentPairsResult);
      return;
    }
    const filteredPairs = currentPairsResult.pairs.filter(p =>
      (p.a.player || "").toLowerCase().includes(term) ||
      (p.b.player || "").toLowerCase().includes(term)
    );
    const filteredResult = { pairs: filteredPairs, leftover: [] };
    renderPairs(filteredResult);
  }

  if (pairSearchInput) {
    pairSearchInput.addEventListener("input", () => {
      renderPairsFiltered();
    });
  }

  // ---------- Add formation ----------
  document.getElementById("addFormationBtn").onclick = async () => {
    if (!formationsRef) {
      alert("Database not connected.");
      return;
    }
    const player = playerInput.value.trim();
    const formRaw = formationInput.value.trim();
    const powerVal = powerInput.value.trim();

    if (!player || !formRaw || !powerVal) {
      alert("Fill all fields correctly.");
      return;
    }

    // Kun 1–4 tillatt
    if (!/^[1-4]$/.test(formRaw)) {
      alert("Formation must be a number between 1 and 4.");
      return;
    }

    const power = Number(powerVal);
    if (isNaN(power)) {
      alert("Power must be a number.");
      return;
    }

    const form = formRaw; // lagres som string "1"–"4"

    try {
      await formationsRef.add({ player, formation: form, power });
      playerInput.value = "";
      formationInput.value = "";
      powerInput.value = "";
    } catch (e) {
      console.error("Add error:", e);
      alert("Failed to add formation: " + e.message);
    }
  };

  // ---------- Clear all ----------
  document.getElementById("clearAllBtn").onclick = async () => {
    if (!formationsRef || !pairsRef) {
      alert("Database not connected.");
      return;
    }
    if (!isAdmin) {
      alert("Only admin can clear everything.");
      return;
    }
    const given = prompt("Admin code:");
    if (given !== ADMIN_CODE) return alert("Incorrect code.");
    if (!confirm("Delete EVERYTHING from formations AND pairs?")) return;

    try {
      const snapF = await formationsRef.get();
      const snapP = await pairsRef.get();
      const batch = db.batch();

      snapF.forEach(doc => batch.delete(doc.ref));
      snapP.forEach(doc => batch.delete(doc.ref));

      await batch.commit();
    } catch (e) {
      console.error("Clear all error:", e);
      alert("Failed to clear list: " + e.message);
    }
  };

  // ---------- Generate & save pairs ----------
  document.getElementById("makePairsBtn").onclick = async () => {
    if (formations.length < 2) {
      alert("Need at least 2 formations.");
      return;
    }
    const result = generatePairs();
    setPairsResult(result);

    if (isAdmin) {
      await savePairsToDb(result);
    } else {
      statusEl.textContent = "Pairs generated locally (not saved, admin only).";
      setTimeout(() => {
        statusEl.textContent = "Connected to database.";
      }, 4000);
    }
  };

  // ---------- Render formations-liste ----------
  function renderList() {
    formationsBody.innerHTML = "";
    formations.forEach((f, i) => {
      const deleteCell = isAdmin
        ? `<button class="btn-danger" data-id="${f.id}">✕</button>`
        : `<span class="muted">-</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${escapeHtml(f.player)}</td>
        <td>${escapeHtml(f.formation)}</td>
        <td>${f.power}</td>
        <td>${deleteCell}</td>`;
      formationsBody.appendChild(tr);
    });

    if (isAdmin) {
      document.querySelectorAll("button[data-id]").forEach(btn => {
        btn.onclick = async () => {
          const id = btn.getAttribute("data-id");
          try {
            await formationsRef.doc(id).delete();
          } catch (e) {
            console.error("Delete error:", e);
            alert("Failed to delete: " + e.message);
          }
        };
      });
    }

    countInfo.textContent = `(${formations.length})`;
    if (!formations.length && !currentPairsResult) {
      pairsContainer.innerHTML = "<span class='muted'>No pairs yet.</span>";
    }
  }

  // ---------- Pairing-logikk ----------
  function generatePairs() {
    const list = [...formations].sort((a, b) => a.power - b.power);
    const used = new Set();
    const pairs = [];
    const leftover = [];

    for (let i = 0; i < list.length; i++) {
      const A = list[i];
      if (used.has(A.id)) continue;

      let best = null;
      let diff = Infinity;

      for (let j = i + 1; j < list.length; j++) {
        const B = list[j];
        if (used.has(B.id)) continue;
        if (A.player === B.player) continue;

        const d = Math.abs(A.power - B.power);
        if (d < diff) {
          diff = d;
          best = B;
        }
      }

      if (best) {
        const total = A.power + best.power;
        pairs.push({ a: A, b: best, diff: diff, total: total });
        used.add(A.id);
        used.add(best.id);
      } else {
        leftover.push(A);
      }
    }

    // Sorter: høyest total power øverst
    pairs.sort((p1, p2) => p2.total - p1.total);

    return { pairs, leftover };
  }

  // ---------- Lagre genererte par i Firestore ----------
  async function savePairsToDb({ pairs }) {
    if (!pairsRef) return;
    try {
      const snap = await pairsRef.get();
      const batch = db.batch();
      snap.forEach(doc => batch.delete(doc.ref));

      pairs.forEach((p, index) => {
        const ref = pairsRef.doc();
        batch.set(ref, {
          index,
          aId: p.a.id,
          aPlayer: p.a.player,
          aFormation: p.a.formation,
          aPower: p.a.power,
          bId: p.b.id,
          bPlayer: p.b.player,
          bFormation: p.b.formation,
          bPower: p.b.power,
          diff: p.diff,
          total: p.total,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      await batch.commit();
      statusEl.textContent = "Pairs saved to database (admin).";
      setTimeout(() => {
        statusEl.textContent = "Connected to database.";
      }, 3000);
    } catch (e) {
      console.error("Save pairs error:", e);
      alert("Failed to save pairs: " + e.message);
    }
  }

  // ---------- Render pairs (kompakte kort, topp 3 i gull) ----------
  function renderPairs({ pairs, leftover }) {
    if (!pairs || pairs.length === 0) {
      pairsContainer.innerHTML = "<span class='muted'>No valid pairs.</span>";
      return;
    }

    const wrap = document.createElement("div");
    wrap.className = "pairs";

    pairs.forEach((p, i) => {
      const isTop3 = i < 3;
      const goldClass = isTop3 ? "gold-glow" : "";

      const card = document.createElement("div");
      card.className = "pair-card";
      card.innerHTML = `
        <div class="pair-header">
          <span class="pair-title ${goldClass}">Pair ${i + 1}</span>
          <span class="pair-meta">Total: ${p.total} | Diff: ${p.diff}</span>
        </div>
        <div class="pair-row">
          <span class="pair-name ${goldClass}">${escapeHtml(p.a.player)}</span>
          <span class="pair-sep">—</span>
          <span class="pair-form">${escapeHtml(p.a.formation)}</span>
          <span class="pair-power">(${p.a.power})</span>
        </div>
        <div class="pair-row">
          <span class="pair-name ${goldClass}">${escapeHtml(p.b.player)}</span>
          <span class="pair-sep">—</span>
          <span class="pair-form">${escapeHtml(p.b.formation)}</span>
          <span class="pair-power">(${p.b.power})</span>
        </div>
      `;
      wrap.appendChild(card);
    });

    if (leftover && leftover.length > 0) {
      const miss = document.createElement("div");
      miss.style.marginTop = "0.75rem";
      miss.innerHTML = "<strong>Unpaired:</strong><br>" +
        leftover.map(f => `${escapeHtml(f.player)} — ${escapeHtml(f.formation)} (${f.power})`).join("<br>");
      wrap.appendChild(miss);
    }

    pairsContainer.innerHTML = "";
    pairsContainer.appendChild(wrap);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }
</script>

</body>
</html>




